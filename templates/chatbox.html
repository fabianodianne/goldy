<!DOCTYPE html>
<html lang="en">
<head>
  <title>Chatbot</title>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="google-signin-client_id" content="353575143157-n1hjiolkfuiqlqq9inej39pcdb90c7er.apps.googleusercontent.com">

  <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
  <link href="{{url_for('static',filename='./css/output.css')}}" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500&display=swap" rel="stylesheet">

  <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.4.2.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
  <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-2.4.2.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <style>
        body {
            font-family: 'Baloo 2', cursive;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* typing dots animation */
        .tiblock {
            align-items: center;
            display: flex;
            height: 18px;
        }

        .ticontainer .tidot {
            background-color: #90949c;
        }

        .tidot {
            -webkit-animation: mercuryTypingAnimation 1.5s infinite ease-in-out;
            border-radius: 100%;
            display: inline-block;
            height: 8px;
            width: 8px;
            margin-right: 4px;
        }

        @-webkit-keyframes mercuryTypingAnimation{
            0% {-webkit-transform: translateY(0px)}
            28% {-webkit-transform: translateY(-5px)}
            44% {-webkit-transform: translateY(0px)}
        }

        .tidot:nth-child(1) {-webkit-animation-delay: 200ms;}
        .tidot:nth-child(2) {-webkit-animation-delay: 300ms;}
        .tidot:nth-child(3) {-webkit-animation-delay: 400ms;}
        /* typing dots animation - end*/

        #hide {
          animation: hideAnimation 0.2s 2s;
          animation-fill-mode: forwards;
        }

        @keyframes hideAnimation {
          from {
            opacity: 100%;
          }
          to {
            opacity: 0%;
            visibility: hidden;
            height: 0;
            width: 0;
          }
        }
    </style>

<div class="z-40 fixed w-screen flex-col items-stretch justify-between overflow-hidden">
    <div class="w-screen bg-blue_bg2 flex justify-between items-center content-center drop-shadow-lg sticky object-top"> <!--header-->
        <div class="flex items-center content-center">
            <div class="flex-col mx-6">
                <p class="text-3xl text-white font-semibold pt-2 drop-shadow-lg">
                    Goldy
                </p>
                <p class="text-white pb-1">
                    Ateneo de Naga University Chatbot for Grade School
                </p>
            </div>
        </div>

        <div class="profile mx-6 py-1 px-2 rounded-lg border-solid border-2 border-blue_btn hover:border-blue_hover hover:drop-shadow-lg">
          <button class="text-white text-xl flex place-items-center">
            <img src="https://img.icons8.com/sf-black/64/FFFFFF/logout-rounded.png" class="h-8 w-8"/>
            <a href="/" onclick="signOut();">Sign Out</a>
          </button>
        </div>

    </div>
</div>

</head>

<body class="scrollbar-hide">
  <section class="msger">
    <header class="msger-header">
      <div class="msger-header-title">
        <i class="fas fa-bug"></i> Chatbot <i class="fas fa-bug"></i>
      </div>
    </header>

    <main class="msger-chat px-0.5 py-14 mb-12 overflow-hidden">
    </main>

    <form class="fixed msger-inputarea bottom-0 h-20 w-screen flex justify-between items-center p-4 gap-2 bg-gradient-to-t from-blue_bg2 to-white">
      <input type="text" class="msger-input bg-inputbox w-full h-full rounded-l-large px-4 py-2 text-gray text-lg shadow-lg border border-gray-300" id="textInput" placeholder="Enter your message here">
      <button type="submit" id="send" class="msger-send-btn w-24 h-full bg-blue_btn hover:bg-blue_hover shadow-lg rounded-r-large text-white text-lg font-medium flex justify-center items-center">Send</button>
    </form>

  </section>

  <!-- partial -->
  <script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>
  <script>
    const msgerForm = get(".msger-inputarea");
    const msgerInput = get(".msger-input");
    const msgerChat = get(".msger-chat");
    const BOT_NAME = "Goldy";
    const PERSON_NAME = "You";
    const welcomeMsg = "Hi there, I am Goldy! I'm here to help you and you can ask me anything!"
    const send = document.getElementById("send");

    appendMessage(BOT_NAME, "static/img/knight.png", "left", welcomeMsg, "row", "r-lg", "tl-lg");

    msgerForm.addEventListener("submit", event => {
      event.preventDefault();
      const msgText = msgerInput.value;
      if (!msgText) return;
      appendMessage(PERSON_NAME, "static/img/user.png", "right", msgText, "row-reverse", "l-lg", "tr-lg", "pl");
      msgerInput.value = "";

      send.disabled = true;
      send.classList.add("disabled");

      botResponse(msgText);
    });

    const typing = `
          <div id="hide" class="msg w-screen float-left flex flex-row">
            <div class="self-end">
              <img src="static/img/knight.png" class="msg-img h-10 w-10 min-w-12 mx-2 drop-shadow-md">
            </div>
            <div class="msg-bubble">
              <div class="msg-info text-gray mt-5">
                <div class="msg-text bg-blue_txtbox rounded-r-lg rounded-tl-lg px-4 py-2 h-full w-fit">
                  <div class="ticontainer">
                    <div class="tiblock">
                        <div class="tidot"></div>
                        <div class="tidot"></div>
                        <div class="tidot"></div>
                    </div>
                  </div>  
                </div>
              </div>  
            </div>
          </div>`;

    function goldyTyping() {
      setTimeout(() => {
        msgerChat.insertAdjacentHTML("beforeend", typing);
      }, 1000);
    }

    function appendMessage(name, img, side, text, flow, s, s1, p_side) {

      const msgHTML = `
          <div class="msg w-screen float-${side} flex flex-${flow}">
            <div class="self-end">
              <img src=${img} class="msg-img h-10 w-10 min-w-12 mx-2 drop-shadow-md">
            </div>
            <div class="msg-bubble w-3/5">
              <div class="msg-info text-gray mt-5 float-${side}">
                <div class="msg-text bg-blue_txtbox rounded-${s} rounded-${s1} px-4 py-2 h-full w-fit">${text}</div>
              </div>  
            </div>
            <div class="w-2/5"></div>
          </div>
          `;
      
      if(name == "You") {
        msgerChat.insertAdjacentHTML("beforeend", msgHTML);
      } else if(name == "Goldy") {
        goldyTyping();
        setTimeout(() => {
          msgerChat.insertAdjacentHTML("beforeend", msgHTML);
          send.disabled = false;
          send.classList.remove("disabled");
        }, 5000);
      }      
      msgerChat.scrollTop += 500;
    }

    function botResponse(rawText) {
      // Bot Response
      $.get("/get", { msg: rawText }).done(function (data) {
        const msgText = data;
        const formattedMsgText = msgText.replace(/\n/g, "<br>");
        appendMessage(BOT_NAME, "static/img/knight.png", "left", formattedMsgText, "row", "r-lg", "tl-lg", "pr");
      });
    }
    
    // Utils
    function get(selector, root = document) {
      return root.querySelector(selector);
    }

    function signOut() {
      var auth2 = gapi.auth2.getAuthInstance();
      session.clear();
      auth2.signOut().then(function () {
        console.log('User signed out.');
      });
    }
  </script>
</body>
</html>